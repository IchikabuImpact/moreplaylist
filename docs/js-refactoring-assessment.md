# JavaScriptリファクタリング診断（public/js）

## 対象
- `public/js/Main.js`
- `public/js/VideoApp.js`

## 総評（強度）
- **現状の強度評価: C（中〜低）**
  - 機能は動作するが、イベント多重登録・重複ロジック・DOM直接組み立ての比率が高く、仕様追加時に不具合を混入しやすい構造。
  - テストは存在するが「性質確認（characterization）」中心で、回帰防止の網羅性は十分とは言いにくい。

## 主要リスク（優先度順）

### 1) イベントハンドラの重複登録（高）
- `attachClickEvents()` が動画リスト更新のたびに呼ばれ、`#video-list` へ `on('click', ...)` を再登録している。
- 結果として、同一クリックで処理が複数回実行される可能性がある（再生/一時停止の挙動不安定、デバッグ難化）。

### 2) 変更点が分散しやすい重複実装（高）
- `feeds_from_keyword` と `feeds_from_feed_url` に、動画リスト描画・ページネーション生成・イベント接続の重複コードが多い。
- 同じ修正を2箇所以上へ適用する必要があり、片方だけ直す不整合リスクが高い。

### 3) イベント責務の二重化（中〜高）
- プレイリスト変更イベントを `VideoApp.setupEventListeners()` と `Main.js` 内の `#playlists change` の双方で扱っている。
- API呼び出しやUI更新の責務境界が曖昧で、バグ時の切り分けが難しい。

### 4) エラーハンドリング方針の不統一（中）
- `fetch`（async/await）と `$.ajax`（callback）が混在。
- JSONパース・エラー表示・ログ出力の形式が統一されていないため、障害解析の一貫性が下がる。

### 5) 画面描画時の安全性（中）
- テンプレート文字列で `video.title` を直接HTMLへ埋め込んでおり、将来的にサニタイズ不足のXSSリスクを増やす。

### 6) グローバルエラー抑制の副作用（中）
- `window.onerror` で YouTube由来を広く握り潰しており、関連不具合の検知が遅れる可能性がある。

## リファクタリング余地（実行しやすい順）

### Phase 1: 低コストで効く安定化（1〜2日）
1. `attachClickEvents()` で `.off(...).on(...)` もしくは「初回1回だけ登録」に変更。
2. 動画描画処理を `renderVideoList(videos)` として共通化。
3. ページネーション描画を `renderPagination(tokens, onNavigate)` に共通化。
4. `Main.js` と `VideoApp.js` のプレイリストchange責務を片方に寄せる。

### Phase 2: デバッグ容易性の向上（2〜4日）
1. API層を分離（`apiClient.js`）し、`fetch` に統一。
2. 例外形式（`{ code, message, cause }`）を揃え、UIメッセージを標準化。
3. ログ出力を `debug/info/warn/error` レベルで統一。

### Phase 3: 長期的な保守性向上（1〜2週間）
1. DOM組み立てを小さなView関数に分割（`videoListView.js` など）。
2. 「状態（現在動画ID、ページトークン、ログイン状態）」を1箇所に集約。
3. 機能単位でテスト追加（イベント重複防止、ページング遷移、エラー表示）。

## 期待できる効果
- 同一不具合の再発率を下げる（重複ロジック削減）。
- クリック/ページングの不安定挙動を減らす（イベント重複防止）。
- バグ解析時間を短縮する（責務境界・エラー方針の統一）。

## 参考（実装観察）
- Characterizationテストは存在し、現行挙動の固定化は一定進んでいる。
- ただし構造改善前提のテスト（ユニット分割に対応したテスト境界）はこれから強化余地あり。
